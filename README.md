# Построение ETL-пайплайна
Ожидается, что на выходе будет DAG в airflow, который будет считаться каждый день за вчера. 

1. Параллельно будем обрабатывать две таблицы. В feed_actions для каждого юзера посчитаем число просмотров и лайков контента. В message_actions для каждого юзера считаем, сколько он получает и отсылает сообщений, скольким людям он пишет, сколько людей пишут ему. Каждая выгрузка должна быть в отдельном таске.

2. Далее объединяем две таблицы в одну.

3. Для этой таблицы считаем все эти метрики в разрезе по полу, возрасту и ос. Делаем три разных таска на каждый срез.

4. И финальные данные со всеми метриками записываем в отдельную таблицу в ClickHouse.

5. Каждый день таблица должна дополняться новыми данными. 

Структура финальной таблицы должна быть такая:

Дата - event_date

Название среза - dimension

Значение среза - dimension_value

Число просмотров - views

Число лайков - likes

Число полученных сообщений - messages_received

Число отправленных сообщений - messages_sent

От скольких пользователей получили сообщения - users_received

Скольким пользователям отправили сообщение - users_sent

Срез — это os, gender и age

Таблицу необходимо загрузить в схему test.

[DAG code](etl_dag.py)

<image src="/img/etl.jpg" alt="">


# Автоматизация отчетности
## Отчет по ключевым метрикам
Необходимо написать отчет, который ежедневно в 11.00 должен приходить в чат.

Отчет должен состоять из двух частей:

1. текст с информацией о значениях ключевых метрик за предыдущий день (DAU, Просмотры, Лайки, CTR)
2. график с значениями метрик за предыдущие 7 дней

Отправка отчета автоматизируется с помощью Airflow. 

[DAG report code](report.py)

<image src="/img/report_af.jpg" alt="">
<image src="/img/report_tg.jpg" alt="">

## Отчет по метрикам приложения
Необходимо написать отчет, который ежедневно в 11.00 должен приходить в чат.

Отчет по работе всего приложения как единого целого.

Отправка отчета автоматизируется с помощью Airflow. 

[DAG report code](report_app.py)

<image src="/img/report_app_af.jpg" alt="">
<image src="/img/report_app_tg1.jpg" alt="">
<image src="/img/report_app_tg2.jpg" alt="">


# Поиск аномалий (система алертов)

Система должна с периодичностью каждые 15 минут проверять 
ключевые метрики — такие как активные пользователи в ленте / мессенджере, 
просмотры, лайки, CTR, количество отправленных сообщений. 

В случае обнаружения аномального значения, в чат должен отправиться алерт — 
сообщение со следующей информацией: метрика, ее значение, величина отклонения.

[DAG alerts code](alerts.py)

<image src="/img/alert_af.jpg" alt="">
<image src="/img/alert_tg1.jpg" alt="">
<image src="/img/alert_tg2.jpg" alt="">